<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>EMOSHOW — Классическая бегущая строка fullscreen</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      overflow: hidden;
      background-color: black;
      color: white;
      font-size: 70px;
      user-select: none;
      display: flex;
      align-items: center;
      position: relative;
    }
    #marquee-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      white-space: nowrap;
    }
    #marquee {
      position: absolute;
      top: 50%;
      left: 0;
      white-space: nowrap;
      transform: translateY(-50%) translateX(100%);
      will-change: transform;
      transition: color 0.2s, background 0.2s;
      pointer-events: none;
      text-align: center;
    }
    /* Анимированные фоны */
    body.bg-raduga {
      background: linear-gradient(270deg, #ff00cc, #3333ff, #00ffcc, #ffff00, #ff00cc 60%);
      background-size: 600% 600%;
      animation: rainbow-bg 12s linear infinite;
    }
    @keyframes rainbow-bg {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    body.bg-drkids {
      background: url('orig.gif') center center / cover no-repeat fixed;
      background-color: #fff2fc;
    }
    /* ДИСКО — динамичные пятна/круги */
    .disco-spot {
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      opacity: 0.65;
      mix-blend-mode: lighten;
      transition: filter 0.4s;
      z-index: 1;
      animation: disco-spot-fade 2.5s infinite alternate;
    }
    @keyframes disco-spot-fade {
      0% { filter: brightness(1.2) blur(0px);}
      50% { filter: brightness(1.7) blur(4px);}
      100% { filter: brightness(1.2) blur(0px);}
    }
    /* ЛУЧИ */
    #luchi-canvas {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 0;
      mix-blend-mode: lighten;
    }
    /* ОГОНЬКИ */
    .firefly {
      position: fixed;
      border-radius: 50%;
      opacity: 0.7;
      pointer-events: none;
      mix-blend-mode: screen;
      z-index: 2;
      box-shadow: 0 0 18px 4px #fff700, 0 0 28px 6px #ff00cc;
      animation: firefly-blink 2s infinite alternate;
    }
    @keyframes firefly-blink {
      0% { filter: brightness(1);}
      100% { filter: brightness(2.5);}
    }
  </style>
</head>
<body>
  <div id="marquee-container">
    <div id="marquee">Загрузка...</div>
  </div>
  <canvas id="luchi-canvas" style="display:none;"></canvas>

  <script>
    const API_URL = "https://emoshow-bot.onrender.com/api/latest?apikey=77777";
    const marquee = document.getElementById("marquee");
    let posX, posY, velX, velY;
    let direction = "left";
    let speedPxPerSec = 100;
    let lastDirection = null;
    let lastConfig = {};
    let bgEffect = "";

    // --- ДИСКО — анимируем круги
    let discoSpots = [];
    function createDiscoSpots() {
      removeDiscoSpots();
      let num = 12;
      const palette = [
        "#ff00cc", "#00ffcc", "#fff700", "#00aaff", "#f9484a", "#00ff00", "#ffb347", "#b388ff"
      ];
      for (let i = 0; i < num; i++) {
        let d = document.createElement("div");
        d.className = "disco-spot";
        let size = Math.random()*200 + 120;
        d.style.width = d.style.height = size + "px";
        d.style.left = Math.random()*(window.innerWidth-size) + "px";
        d.style.top = Math.random()*(window.innerHeight-size) + "px";
        d.style.background = `radial-gradient(circle, ${palette[i%palette.length]} 0%, transparent 85%)`;
        d.style.animationDelay = (Math.random()*2.5) + "s";
        document.body.appendChild(d);
        discoSpots.push(d);
      }
    }
    function removeDiscoSpots() {
      for (let d of discoSpots) document.body.removeChild(d);
      discoSpots = [];
    }

    // --- ЛУЧИ (динамика через canvas)
    let luchiActive = false;
    let luchiCanvas = document.getElementById('luchi-canvas');
    let luchiCtx = luchiCanvas.getContext('2d');
    function resizeLuchiCanvas() {
      luchiCanvas.width = window.innerWidth;
      luchiCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeLuchiCanvas);

    function drawLuchi(ts) {
      if (!luchiActive) return;
      let ctx = luchiCtx;
      let w = luchiCanvas.width, h = luchiCanvas.height;
      ctx.clearRect(0,0,w,h);
      let rays = 13, centerX = w/2, centerY = h/2;
      let baseRadius = Math.max(w,h)*0.48;
      let time = (ts/900) % (2*Math.PI);
      for (let i=0;i<rays;i++) {
        let angle = (2*Math.PI/rays)*i + time;
        let length = baseRadius*(0.88 + 0.11*Math.sin(time*2 + i));
        let x2 = centerX + Math.cos(angle)*length;
        let y2 = centerY + Math.sin(angle)*length;
        let grad = ctx.createLinearGradient(centerX, centerY, x2, y2);
        grad.addColorStop(0, "#fff700");
        grad.addColorStop(0.4, "#ff00cc");
        grad.addColorStop(0.7, "#00ffcc");
        grad.addColorStop(1, "transparent");
        ctx.save();
        ctx.globalAlpha = 0.33 + 0.44*Math.abs(Math.sin(time*2+i));
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(x2, y2);
        ctx.lineWidth = 55 + 30*Math.abs(Math.cos(time*2 + i));
        ctx.strokeStyle = grad;
        ctx.stroke();
        ctx.restore();
      }
      requestAnimationFrame(drawLuchi);
    }
    function startLuchi() {
      luchiActive = true;
      luchiCanvas.style.display = '';
      resizeLuchiCanvas();
      requestAnimationFrame(drawLuchi);
    }
    function stopLuchi() {
      luchiActive = false;
      luchiCanvas.style.display = 'none';
      luchiCtx.clearRect(0,0,luchiCanvas.width,luchiCanvas.height);
    }

    // --- ОГОНЬКИ (firefly, плавные движения)
    let fireflies = [];
    function createFireflies() {
      removeFireflies();
      let num = 16;
      for (let i = 0; i < num; i++) {
        let f = document.createElement("div");
        f.className = "firefly";
        let size = Math.random()*16+12;
        f.style.width = f.style.height = size + "px";
        f.style.left = Math.random()*window.innerWidth + "px";
        f.style.top = Math.random()*window.innerHeight + "px";
        f.style.background = `radial-gradient(circle, #fff700 0%, #ff00cc 90%, transparent 100%)`;
        document.body.appendChild(f);
        fireflies.push({
          el: f,
          x: parseFloat(f.style.left),
          y: parseFloat(f.style.top),
          dx: (Math.random()-0.5)*1.5,
          dy: (Math.random()-0.5)*1.5,
          size: size
        });
      }
      animateFireflies();
    }
    function removeFireflies() {
      for (let f of fireflies) if (f.el && f.el.parentNode) f.el.parentNode.removeChild(f.el);
      fireflies = [];
    }
    function animateFireflies() {
      for (let f of fireflies) {
        f.x += f.dx*4 + (Math.random()-0.5)*2;
        f.y += f.dy*4 + (Math.random()-0.5)*2;
        if (f.x < 0 || f.x > window.innerWidth-f.size) f.dx *= -1;
        if (f.y < 0 || f.y > window.innerHeight-f.size) f.dy *= -1;
        f.el.style.left = f.x + "px";
        f.el.style.top = f.y + "px";
      }
      if (fireflies.length) setTimeout(animateFireflies, 50);
    }

    // --- Переключение фонов
    function setBodyBgEffect(effect) {
      document.body.classList.remove("bg-raduga","bg-disco","bg-drkids");
      removeDiscoSpots();
      stopLuchi();
      removeFireflies();

      if (effect === "raduga") {
        document.body.classList.add("bg-raduga");
      } else if (effect === "disco") {
        createDiscoSpots();
      } else if (effect === "luchi") {
        startLuchi();
      } else if (effect === "ogni") {
        createFireflies();
      } else if (effect === "drkids") {
        document.body.classList.add("bg-drkids");
      }
    }

    // --- ОСНОВНОЙ КОД БЕГУЩЕЙ СТРОКИ (как раньше)
    function animate(timestamp) {
      if (!animate.last) animate.last = timestamp;
      const elapsed = (timestamp - animate.last) / 1000;
      animate.last = timestamp;

      if (direction === "left") {
        if (posX === undefined || lastDirection !== "left") {
          posX = marquee.parentElement.offsetWidth;
          lastDirection = "left";
          marquee.style.top = "50%";
          marquee.style.left = "0";
        }
        posX -= speedPxPerSec * elapsed;
        const textWidth = marquee.offsetWidth;
        if (posX < -textWidth) posX = marquee.parentElement.offsetWidth;
        marquee.style.transform = `translateY(-50%) translateX(${posX}px)`;
      }
      else if (direction === "right") {
        if (posX === undefined || lastDirection !== "right") {
          posX = -marquee.offsetWidth;
          lastDirection = "right";
          marquee.style.top = "50%";
          marquee.style.left = "0";
        }
        posX += speedPxPerSec * elapsed;
        if (posX > marquee.parentElement.offsetWidth) posX = -marquee.offsetWidth;
        marquee.style.transform = `translateY(-50%) translateX(${posX}px)`;
      }
      else if (direction === "fixed") {
        marquee.style.position = "absolute";
        marquee.style.top = "50%";
        marquee.style.left = "50%";
        marquee.style.transform = "translate(-50%, -50%)";
        marquee.style.whiteSpace = "pre-line";
      }
      else if (direction === "pingpong") {
        if (
          posX === undefined || posY === undefined ||
          lastDirection !== "pingpong"
        ) {
          const cont = marquee.parentElement;
          posX = 0;
          posY = 0;
          let angle = (Math.random() * 30 + 30) * Math.PI / 180;
          if (Math.random() < 0.5) angle = Math.PI - angle;
          velX = Math.cos(angle) * speedPxPerSec;
          velY = Math.sin(angle) * speedPxPerSec;
          lastDirection = "pingpong";
          marquee.style.whiteSpace = "pre-line";
        }
        posX += velX * elapsed;
        posY += velY * elapsed;
        const cont = marquee.parentElement;
        const mW = marquee.offsetWidth;
        const mH = marquee.offsetHeight;
        if (posX < 0) { posX = 0; velX = -velX; }
        if (posX + mW > cont.offsetWidth) { posX = cont.offsetWidth - mW; velX = -velX; }
        if (posY < 0) { posY = 0; velY = -velY; }
        if (posY + mH > cont.offsetHeight) { posY = cont.offsetHeight - mH; velY = -velY; }
        marquee.style.left = posX + "px";
        marquee.style.top = posY + "px";
        marquee.style.transform = "none";
      }

      requestAnimationFrame(animate);
    }

    function updateMarquee(data) {
      let needReset = false;
      let needUpdateText = false;
      // Если поменялось направление или размер — сбрасываем физику.
      if (
        lastConfig.direction !== data.direction ||
        lastConfig.size !== data.size
      ) {
        needReset = true;
      }
      if (lastConfig.text !== data.text) {
        needReset = true;
        needUpdateText = true;
      }
      lastConfig = {
        direction: data.direction,
        text: data.text,
        size: data.size
      };

      if (needUpdateText) marquee.textContent = data.text;
      marquee.style.color = data.color;

      // Анимированные фоны
      if (["raduga","disco","luchi","ogni","drkids"].includes(data.bg)) {
        setBodyBgEffect(data.bg);
        bgEffect = data.bg;
      } else {
        document.body.style.backgroundColor = data.bg;
        setBodyBgEffect("");
        bgEffect = "";
      }

      marquee.style.fontSize = data.size + "px";
      direction = data.direction || "left";

      // Скорость: перевод из 1-9 в 100-600 px/s
      const minSpeedPx = 100, maxSpeedPx = 600;
      let speed = Number(data.speed);
      speed = Math.min(Math.max(speed, 1), 9);
      speedPxPerSec = minSpeedPx + (speed - 1) * (maxSpeedPx - minSpeedPx) / 8;

      if (direction === "fixed") {
        marquee.style.position = "absolute";
        marquee.style.whiteSpace = "pre-line";
      } else if (direction === "pingpong") {
        marquee.style.position = "absolute";
        marquee.style.whiteSpace = "pre-line";
      } else {
        marquee.style.whiteSpace = "nowrap";
        marquee.style.position = "absolute";
        marquee.style.left = "0";
        marquee.style.top = "50%";
      }

      if (needReset) {
        lastDirection = null;
        posX = posY = undefined;
      }
    }

    async function fetchData() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error("Ошибка сети");
        const data = await response.json();
        updateMarquee(data);
      } catch (error) {
        console.error("Ошибка при получении данных:", error);
      }
    }

    requestAnimationFrame(animate);
    setInterval(fetchData, 5000);
    fetchData();
  </script>
</body>
</html>
